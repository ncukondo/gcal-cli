#!/usr/bin/env bash
set -euo pipefail

# Check the state of a Claude Code agent running in a tmux pane.
#
# Usage: check-agent-state.sh <pane-id>
# Output: "trust", "permission", "idle", "working", or "starting"
#
# Detection methods (in priority order):
#   1. Hooks-based state file (/tmp/claude-agent-states/<pane-id>)
#   2. tmux capture-pane fallback

PANE="${1:?Usage: check-agent-state.sh <pane-id>}"
WORKER_STATE_DIR="/tmp/claude-agent-states"
STATE_FILE="$WORKER_STATE_DIR/$PANE"

IS_STARTING=false

# --- Method 1: Hooks-based state file (highest priority) ---
if [[ -f "$STATE_FILE" ]]; then
  FILE_MTIME=$(stat -c %Y "$STATE_FILE" 2>/dev/null || echo 0)
  NOW=$(date +%s)
  AGE=$((NOW - FILE_MTIME))

  if [[ $AGE -lt 120 ]]; then
    STATE=$(cat "$STATE_FILE" 2>/dev/null || echo "")
    if [[ -n "$STATE" ]]; then
      if [[ "$STATE" == "starting" ]]; then
        IS_STARTING=true
        # Fall through to tmux detection
      elif [[ "$STATE" == "permission" ]]; then
        echo "trust"
        exit 0
      else
        echo "$STATE"
        exit 0
      fi
    fi
  fi
fi

# --- Method 2: tmux capture-pane fallback ---
if ! tmux has-session -t "$PANE" 2>/dev/null; then
  echo "error: pane not found"
  exit 1
fi

CONTENT=$(tmux capture-pane -t "$PANE" -p -S -50 2>/dev/null)

# Trust prompt detection
if echo "$CONTENT" | grep -q 'folder' && \
   echo "$CONTENT" | grep -q 'confirm'; then
  echo "trust"
  exit 0
fi

# Idle detection: has input prompt "❯" without spinner on prompt line
if echo "$CONTENT" | grep -q '❯'; then
  PROMPT_LINE=$(echo "$CONTENT" | grep '❯' | tail -1)

  if echo "$PROMPT_LINE" | grep -qE '(⠋|⠙|⠹|⠸|⠼|⠴|⠦|⠧|⠇|⠏)'; then
    echo "working"
  else
    echo "idle"
  fi
  exit 0
fi

# No prompt found
if [[ "$IS_STARTING" == "true" ]]; then
  echo "starting"
  exit 0
fi

echo "working"
